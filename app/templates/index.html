{% extends "base.html" %}

{% block content %}
<div class="upload-area" id="drop-zone">
    <form id="upload-form">
        <div class="icon">üìÅ</div>
        <h3>Select files to share</h3>
        <p>Drag and drop files here, or click to browse</p>
        <input type="file" id="file-input" multiple required hidden>
        <button type="button" class="btn primary" onclick="document.getElementById('file-input').click()">Browse
            Files</button>
        <ul id="file-list"></ul>
        <button type="submit" class="btn success" id="share-btn" disabled>Share Files</button>
    </form>
    <div id="progress" class="hidden">Uploading...</div>
</div>

<div id="result" class="hidden result-box">
    <h3>‚úÖ Files Shared!</h3>
    <p>Send this link to the receiver:</p>
    <div class="link-box">
        <input type="text" id="share-link" readonly>
        <button class="btn secondary" onclick="copyLink()">Copy</button>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const shareBtn = document.getElementById('share-btn');
    const uploadForm = document.getElementById('upload-form');
    let selectedFiles = [];

    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        // Append new files to existing selection
        selectedFiles = [...selectedFiles, ...Array.from(files)];
        updateFileList();
    }

    function updateFileList() {
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.textContent = `${file.name} (${formatSize(file.size)})`;
            fileList.appendChild(li);
        });
        shareBtn.disabled = selectedFiles.length === 0;
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (selectedFiles.length === 0) return;

        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });

        shareBtn.disabled = true;
        shareBtn.textContent = 'Uploading...';

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('upload-form').classList.add('hidden');
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('share-link').value = data.link;
            } else {
                alert('Upload failed');
                shareBtn.disabled = false;
                shareBtn.textContent = 'Share Files';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
            shareBtn.disabled = false;
            shareBtn.textContent = 'Share Files';
        }
    });

    function copyLink() {
        const copyText = document.getElementById("share-link");
        copyText.select();
        document.execCommand("copy");
        // Or navigator.clipboard.writeText(copyText.value);
        alert("Link copied!");
    }
</script>
{% endblock %}