{% extends "base.html" %}

{% block content %}
<div class="upload-area" id="drop-zone">
    <form id="upload-form">
        <div class="icon">üìÅ</div>
        <h3>Select files to share</h3>
        <p>Drag and drop files here, or click to browse</p>
        <input type="file" id="file-input" multiple required hidden>
        
        <div style="margin: 20px 0; text-align: left;">
            <div style="margin-bottom: 8px;">
                <label style="cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="mode" value="manual" checked style="margin-right: 8px;">
                    Manual revoking
                </label>
            </div>
            <div>
                <label style="cursor: pointer; display: flex; align-items: center;">
                    <input type="radio" name="mode" value="auto" style="margin-right: 8px;">
                    Revoke automatically after
                    <input type="number" id="minutes" min="1" max="1440" step="1" value="10" 
                           style="width: 60px; margin: 0 5px; padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px;" 
                           disabled>
                    minutes
                </label>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
             <button type="button" class="btn primary" onclick="document.getElementById('file-input').click()">Browse Files</button>
        </div>

        <ul id="file-list"></ul>
        <button type="submit" class="btn success" id="share-btn" disabled>Share Files</button>
    </form>
    <div id="progress" class="hidden" style="margin-top: 20px;">
        <div style="background: #e2e8f0; border-radius: 6px; height: 10px; overflow: hidden;">
            <div id="progress-bar" style="background: var(--primary); width: 0%; height: 100%; transition: width 0.2s;"></div>
        </div>
        <p id="progress-text" style="text-align: center; margin-top: 5px; font-size: 0.9em; color: var(--text-muted);">Uploading: 0%</p>
    </div>
</div>

<div id="result" class="hidden result-box">
    <h3>‚úÖ Files Shared!</h3>
    <p>Send this link to the receiver:</p>
    <div class="link-box">
        <input type="text" id="share-link" readonly>
        <button id="copy-btn" class="btn secondary" onclick="copyLink()">Copy</button>
    </div>
    
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <p id="expiry-info" style="color: #64748b; font-size: 0.9em; margin-bottom: 15px;"></p>
        <button id="revoke-btn" class="btn" style="background-color: #ef4444; color: white; width: 100%;">Revoke Link Now</button>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const fileList = document.getElementById('file-list');
    const shareBtn = document.getElementById('share-btn');
    const uploadForm = document.getElementById('upload-form');
    const minutesInput = document.getElementById('minutes');
    const modeRadios = document.getElementsByName('mode');
    
    // Progress elements
    const progressDiv = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    let selectedFiles = [];
    let currentToken = null;

    // Radio button logic
    modeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'auto') {
                minutesInput.disabled = false;
                minutesInput.focus();
            } else {
                minutesInput.disabled = true;
            }
        });
    });

    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        // Append new files to existing selection
        selectedFiles = [...selectedFiles, ...Array.from(files)];
        updateFileList();
    }

    function updateFileList() {
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.textContent = `${file.name} (${formatSize(file.size)})`;
            fileList.appendChild(li);
        });
        shareBtn.disabled = selectedFiles.length === 0;
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (selectedFiles.length === 0) return;

        // Determine duration
        let duration = 'manual';
        const selectedMode = document.querySelector('input[name="mode"]:checked').value;
        
        if (selectedMode === 'auto') {
            const mins = minutesInput.value;
            if (!mins || mins < 1) {
                alert("Please enter a valid number of minutes.");
                minutesInput.focus();
                return;
            }
            duration = mins;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });
        formData.append('duration', duration);

        shareBtn.disabled = true;
        shareBtn.textContent = 'Uploading...';
        
        // Show progress UI
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = 'Uploading: 0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/upload', true);

        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = 'Uploading: ' + percentComplete + '%';
            }
        };

        xhr.onload = function() {
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                currentToken = data.token;
                
                document.getElementById('upload-form').classList.add('hidden');
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('share-link').value = data.link;
                
                const expiryInfo = document.getElementById('expiry-info');
                if (data.expires_at) {
                    const expiryDate = new Date(data.expires_at);
                    expiryInfo.textContent = `Expires: ${expiryDate.toLocaleTimeString()} (${expiryDate.toLocaleDateString()})`;
                } else {
                    expiryInfo.textContent = "Status: Active (Manual revocation)";
                }
            } else {
                alert('Upload failed');
                shareBtn.disabled = false;
                shareBtn.textContent = 'Share Files';
                progressDiv.classList.add('hidden');
            }
        };

        xhr.onerror = function() {
            console.error('Network Error');
            alert('An error occurred');
            shareBtn.disabled = false;
            shareBtn.textContent = 'Share Files';
            progressDiv.classList.add('hidden');
        };

        xhr.send(formData);
    });

    document.getElementById('revoke-btn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to revoke this link immediately? The receiver will no longer be able to download files.')) {
            return;
        }
        
        try {
            const response = await fetch(`/revoke/${currentToken}`, {
                method: 'POST'
            });
            
            if (response.ok) {
                document.getElementById('result').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="color: #ef4444;">Link Revoked</h3>
                        <p>The share link is no longer active.</p>
                        <button class="btn primary" onclick="location.reload()">Share More Files</button>
                    </div>
                `;
            } else {
                alert("Failed to revoke link.");
            }
        } catch (error) {
            console.error(error);
            alert("Error revoking link.");
        }
    });

    function copyLink() {
        const copyText = document.getElementById("share-link");
        const copyBtn = document.getElementById("copy-btn");
        
        copyText.select();
        document.execCommand("copy");
        // Or navigator.clipboard.writeText(copyText.value);
        
        // Show feedback
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        copyBtn.style.backgroundColor = "var(--success)";
        
        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.backgroundColor = ""; // Revert to default
        }, 1500);
    }
</script>
{% endblock %}